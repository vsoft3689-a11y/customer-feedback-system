<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Panel - Products</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #fff8dc;
      color: #343a40;
    }
    .navbar-brand {
      font-weight: 700;
      font-size: 1.5rem;
    }
    .product-card {
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 6px;
      overflow: hidden;
      background: white;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .product-image {
      max-height: 180px;
      object-fit: cover;
      width: 100%;
    }
    .product-body {
      padding: 15px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    #searchInput {
      max-width: 180px;
      margin-left: 10px;
    }
    #orderNowWrapper {
      padding: 10px 20px;
      background: #fff8dc;
      border-bottom: 1px solid #ddd;
    }
    #orderNowBtn {
      font-size: 1.1rem;
      font-weight: bold;
      padding: 10px 24px;
    }
    .feedback-summary {
      font-size: 0.9rem;
      margin-top: 8px;
      color: #555;
    }
    .feedback-summary span {
      margin-right: 10px;
    }
    .user-comment {
      margin-top: 8px;
      font-size: 0.9rem;
      border-top: 1px solid #ddd;
      padding-top: 6px;
    }
    .admin-comment {
      margin-top: 4px;
      font-style: italic;
      color: #007bff;
    }
  </style>
</head>
<body class="d-flex flex-column min-vh-100">

  <nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <a class="navbar-brand" href="user.html">User Panel</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navMenu"
            aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav ml-auto align-items-center">
        <li class="nav-item"><a class="nav-link" href="./user-products.html">Products</a></li>
        <li class="nav-item"><a class="nav-link" href="./user-feedback.html">Feedback</a></li>
        <li class="nav-item"><a class="nav-link" href="./order.html">My Orders</a></li>
        <li class="nav-item"><input id="searchInput" class="form-control form-control-sm" type="search" placeholder="Search products" aria-label="Search"></li>
        <li class="nav-item"><span class="nav-link disabled">Logged in as: <strong id="userNameDisplay"></strong></span></li>
        <li class="nav-item"><a class="nav-link" href="#" id="logoutBtn">Logout</a></li>
      </ul>
    </div>
  </nav>

  <div id="orderNowWrapper" class="text-right">
    <button id="orderNowBtn" class="btn btn-danger" disabled>Order Now</button>
  </div>

  <div class="container flex-fill mt-4">
    <h3 class="mb-4">Available Products</h3>
    <div id="productsContainer" class="row">
      <!-- Products will load here -->
    </div>
  </div>

  <footer class="bg-success text-white text-center py-3 mt-auto">&copy; 2025 Feedback App</footer>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>

  <script>
    $(function () {
      const API = "http://localhost:8080/api";
      const user = JSON.parse(localStorage.getItem("feedbackUser")) || { name: "Guest", id: 0 };
      $("#userNameDisplay").text(user.name);

      $("#logoutBtn").click(e => {
        e.preventDefault();
        localStorage.removeItem("feedbackUser");
        window.location = "login.html";
      });

      let products = [];
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      let productFeedbacks = {};  // key: productId, value: array of feedback objects

      function saveCart() {
        localStorage.setItem("cart", JSON.stringify(cart));
        $("#orderNowBtn").prop("disabled", cart.length === 0);
      }

      function fetchFeedbacksFor(productId) {
        return $.ajax({
          url: `${API}/feedback/product/${productId}`,
          method: "GET"
        });
      }

      function getFeedbackSummary(productId) {
        const list = productFeedbacks[productId] || [];
        if (!list.length) return '';
        const filtered = list;  // optionally filter by status
        const avg = (filtered.reduce((sum, f) => sum + f.rating, 0) / filtered.length).toFixed(1);
        return `
          <div class="feedback-summary">
            <span>‚≠ê ${avg} / 5</span>
            <span>(${filtered.length} review${filtered.length > 1 ? 's' : ''})</span>
          </div>
        `;
      }

      function renderFeedbackDetails(productId) {
        const list = productFeedbacks[productId] || [];
        if (!list.length) {
          return `<div class="user-comment"><small>No feedback yet.</small></div>`;
        }
        return list.map(fb => {
          let html = `<div class="user-comment"><strong>${fb.userName}</strong> (${fb.rating}/5): ${fb.comment}</div>`;
          if (fb.adminComment) {
            html += `<div class="admin-comment">Admin: ${fb.adminComment}</div>`;
          }
          return html;
        }).join('');
      }

      function renderProducts(list) {
        const container = $("#productsContainer");
        container.empty();
        if (!list.length) {
          container.html("<p>No products found.</p>");
          return;
        }

        list.forEach(p => {
          const effectivePrice = (p.price * (100 - p.discount) / 100).toFixed(2);
          const cartItem = cart.find(i => i.id === p.id);
          const quantity = cartItem ? cartItem.quantity : 0;
          const imageSrc = p.image ? `http://localhost:8080${p.image}` : 'https://via.placeholder.com/300x180?text=No+Image';

          container.append(`
            <div class="col-md-4 d-flex">
              <div class="product-card flex-fill d-flex flex-column">
                <img src="${imageSrc}" alt="${p.name}" class="product-image" />
                <div class="product-body" id="body-p-${p.id}">
                  <h5>${p.name}</h5>
                  <p>${p.description || ''}</p>
                  <p>Price: <del>$${p.price.toFixed(2)}</del> <strong>$${effectivePrice}</strong> (${p.discount}% off)</p>
                  <div>
                    <button class="btn btn-sm btn-outline-primary add-cart-btn"
                          data-id="${p.id}"
                          data-name="${p.name}"
                          data-price="${p.price}"
                          data-discount="${p.discount}"
                          data-image="${p.image || ''}">
                      Add to Cart
                    </button>
                    <a href="user-feedback.html?productId=${p.id}" class="btn btn-sm btn-link">Feedback</a>
                  </div>
                  <small>In Cart: ${quantity}</small>
                  <div class="feedback-summary" id="summary-p-${p.id}"></div>
                  <div class="feedback-details" id="details-p-${p.id}"></div>
                </div>
              </div>
            </div>
          `);

          fetchFeedbacksFor(p.id).done(fbArr => {
            productFeedbacks[p.id] = fbArr;
            $(`#summary-p-${p.id}`).html(getFeedbackSummary(p.id));
            $(`#details-p-${p.id}`).html(renderFeedbackDetails(p.id));
          }).fail(err => {
            console.error("Error fetching feedback for product", p.id, err);
          });
        });
      }

      $("#searchInput").on("input", function() {
        const term = $(this).val().toLowerCase();
        const filtered = products.filter(p =>
          p.name.toLowerCase().includes(term) ||
          (p.description && p.description.toLowerCase().includes(term))
        );
        renderProducts(filtered);
      });

      $("#productsContainer").on("click", ".add-cart-btn", function() {
        const id = $(this).data("id");
        const name = $(this).data("name");
        const price = parseFloat($(this).data("price"));
        const discount = parseFloat($(this).data("discount"));
        const image = $(this).data("image");
        let item = cart.find(c => c.id === id);
        if (item) {
          item.quantity += 1;
        } else {
          item = { id, name, price, discount, image, quantity: 1, status: "In Cart", userId: user.id };
          cart.push(item);
        }
        saveCart();
        renderProducts(products);
      });

      $("#orderNowBtn").click(function() {
        if (cart.length === 0) {
          alert("Your cart is empty.");
          return;
        }
        cart.forEach(item => {
          item.status = "Purchased";
          item.userId = user.id;
        });
        let orders = JSON.parse(localStorage.getItem("orders")) || [];
        orders = orders.concat(cart);
        localStorage.setItem("orders", JSON.stringify(orders));
        localStorage.removeItem("cart");
        cart = [];
        saveCart();
        alert("Order placed successfully!");
        window.location.href = "order.html";
      });

      function loadProducts() {
        $.ajax({
          url: `${API}/products`,
          method: "GET",
          success(data) {
            products = data || [];
            renderProducts(products);
          },
          error() {
            alert("Failed to load products.");
          }
        });
      }

      loadProducts();
      saveCart();
    });
  </script>

</body>
</html> 