<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Manage Feedback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background: #d1ecf1; color: #0c5460; }
    .navbar-brand { font-weight: 700; font-size: 1.5rem; }
    table thead { background-color: #17a2b8; color: white; }
    table tbody tr:hover { background-color: #bee5eb; }
    .btn-update { background-color: #0c5460; color: white; }
    .btn-update:hover { background-color: #08464a; }
    .btn-delete { background-color: #bd2130; color: white; }
    .btn-delete:hover { background-color: #8f1621; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-info">
    <a class="navbar-brand" href="admin.html">Admin Panel</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item"><a href="./admin-products.html" class="nav-link">Manage Products</a></li>
        <li class="nav-item"><a href="./admin-feedback.html" class="nav-link active">Manage Feedback</a></li>
        <li class="nav-item"><a href="#" id="logoutBtn" class="nav-link">Logout</a></li>
      </ul>
    </div>
  </nav>

  <div class="container mt-4">
    <h3>User Feedbacks</h3>
    <table class="table table-bordered" id="feedbackTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>User</th>
          <th>Product</th>
          <th>Feedback</th>
          <th>Rating</th> <!-- NEW COLUMN -->
          <th>Admin Comment</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <footer class="bg-info text-white text-center py-3 mt-auto border-top">
    &copy; 2025 Feedback App - Manage Feedback
  </footer>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    const API_BASE = "http://localhost:8080/api";

    $(function() {
      loadFeedback();

      $("#feedbackTable").on("click", ".btn-update", function() {
        const tr = $(this).closest("tr");
        const id = $(this).data("id");
        const adminComment = tr.find(".admin-comment-input").val().trim();

        if (!adminComment) {
          alert("Please enter a review comment.");
          return;
        }

        $.ajax({
          url: `${API_BASE}/feedback/${id}`,
          method: "PATCH",
          contentType: "application/json",
          data: JSON.stringify({ adminComment }),
          success: function() {
            alert("Review submitted/updated.");
            loadFeedback();
          },
          error: function(err) {
            console.error("Update error:", err);
            alert("Failed to update feedback");
          }
        });
      });

      $("#feedbackTable").on("click", ".btn-delete-review", function() {
        const id = $(this).data("id");
        if (!confirm("Are you sure you want to delete the admin review/comment?")) return;

        $.ajax({
          url: `${API_BASE}/feedback/${id}`,
          method: "PATCH",
          contentType: "application/json",
          data: JSON.stringify({ adminComment: null }),
          success: function() {
            alert("Admin reply deleted.");
            loadFeedback();
          },
          error: function(err) {
            console.error("Delete comment error:", err);
            alert("Failed to delete the review comment");
          }
        });
      });

      $("#feedbackTable").on("click", ".btn-delete-feedback", function() {
        const id = $(this).data("id");
        if (!confirm("Are you sure you want to delete this feedback entirely?")) return;

        $.ajax({
          url: `${API_BASE}/feedback/${id}`,
          method: "DELETE",
          success: function() {
            alert("Feedback deleted.");
            loadFeedback();
          },
          error: function(err) {
            console.error("Delete feedback error:", err);
            alert("Failed to delete feedback");
          }
        });
      });

      $("#logoutBtn").click(function(e) {
        e.preventDefault();
        localStorage.removeItem("feedbackUser");
        window.location = "login.html";
      });
    });

    function loadFeedback() {
      $.ajax({
        url: `${API_BASE}/feedback`,
        method: "GET",
        success: function(feedbacks) {
          const tbody = $("#feedbackTable tbody");
          tbody.empty();

          if (!feedbacks || feedbacks.length === 0) {
            tbody.append("<tr><td colspan='7'>No feedback available.</td></tr>");
            return;
          }

          feedbacks.forEach(fb => {
            const userName = fb.userName || "Unknown";
            const productName = fb.productName || "Unknown";
            const adminComment = fb.adminComment ?? "";
            const rating = fb.rating != null ? fb.rating : "N/A";

            tbody.append(`
              <tr>
                <td>${fb.id}</td>
                <td>${userName}</td>
                <td>${productName}</td>
                <td>${fb.comment}</td>
                <td>${rating}</td>
                <td>
                  <input type="text" class="form-control admin-comment-input mb-1" placeholder="Write review..." value="${adminComment}" />
                </td>
                <td>
                  <button class="btn btn-sm btn-update" data-id="${fb.id}">Save</button>
                  <button class="btn btn-sm btn-delete-review ml-1" data-id="${fb.id}">Delete Reply</button>
                  <button class="btn btn-sm btn-delete-feedback ml-1" data-id="${fb.id}">Delete Feedback</button>
                </td>
              </tr>
            `);
          });
        },
        error: function(err) {
          console.error("Load feedback error:", err);
          alert("Failed to load feedback");
        }
      });
    }
  </script>
</body>
</html>